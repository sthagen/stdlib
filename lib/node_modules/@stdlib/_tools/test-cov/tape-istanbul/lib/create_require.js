/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

/*
* WARNING: this is based on the internal [`module`][1] file within Node.js. The implementation uses private methods exposed on the `Module` object. Given that they are private, breakage is possible.
*
* [1]: https://github.com/nodejs/node/blob/ebc8c37f70a84a64851b440493f3441eb9f70fdb/lib/internal/module.js
* [2]: https://github.com/nodejs/node/blob/f6070a1a02d946b0caad7ee8bee3c2d583ebad4b/lib/internal/bootstrap_node.js
*/

// MODULES //

var proc = require( 'process' );
var Module = require( 'module' );
var dirname = require( '@stdlib/utils/dirname' );


// VARIABLES //

var nodeModulePaths = Module._nodeModulePaths; // eslint-disable-line no-underscore-dangle
var resolveFilename = Module._resolveFilename; // eslint-disable-line no-underscore-dangle
var extensions = Module._extensions; // eslint-disable-line no-underscore-dangle
var cache = Module._cache; // eslint-disable-line no-underscore-dangle
var main = require.main;


// MAIN //

/**
* Returns a `require` function.
*
* @private
* @param {string} id - module id (filepath)
* @returns {Function} require function
*/
function createRequire( id ) {
	var module = new Module( id );

	// Module filename:
	module.filename = id;

	// Module `node_modules` paths:
	module.paths = nodeModulePaths( dirname( id ) );

	/**
	* Attempts to load a module.
	*
	* @private
	* @param {string} path - module id
	* @returns {void}
	*/
	function require( path ) {
		try {
			return module.require( path );
		} finally {}
	}

	/**
	* Attempts to resolve a module.
	*
	* @private
	* @param {string} name - module
	* @returns {string} module filepath
	*/
	function resolve( name ) {
		return resolveFilename( name, module, false );
	}

	// Application entry point:
	require.main = main;

	// Attach method to resolve a module:
	require.resolve = resolve;

	// Support for extra extension types:
	require.extensions = extensions;

	// Use the existing module cache:
	require.cache = cache;

	return require;
}


// EXPORTS //

module.exports = createRequire;
